{"version":3,"sources":["stops-overlay.js"],"names":["StopsOverlay","context","map","on","_refreshStops","getZoom","props","minZoom","forceUpdate","bounds","getBounds","equals","lastBounds","setTimeout","refreshStops","minLat","getSouth","maxLat","getNorth","minLon","getWest","maxLon","getEast","setLocation","setViewedStop","setMainPanelContent","stops","languageConfig","mobileView","length","createStopMarker","stop","id","MapLayer","propTypes","PropTypes","number","queryMode","string","array","func","defaultProps","StopMarker","_onClickView","stopId","name","lat","lon","idArr","split","radius","half","quarter","html","icon","className","iconSize","stopViewer","Component","bool","object","mapStateToProps","state","ownProps","otp","overlay","transit","currentQuery","mode","config","language","mapDispatchToProps","findStopsWithinBBox","clearStops"],"mappings":"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","file":"stops-overlay.js","sourcesContent":["import { divIcon } from 'leaflet'\nimport React, { Component, PropTypes } from 'react'\nimport { connect } from 'react-redux'\nimport { FeatureGroup, MapLayer, Popup, Marker } from 'react-leaflet'\nimport { Button } from 'react-bootstrap'\n\nimport SetFromToButtons from './set-from-to'\nimport { hasTransit } from '../../util/itinerary'\nimport { isMobile } from '../../util/ui'\nimport { findStopsWithinBBox, clearStops } from '../../actions/api'\nimport { setLocation } from '../../actions/map'\nimport { setViewedStop, setMainPanelContent } from '../../actions/ui'\n\nclass StopsOverlay extends MapLayer {\n  static propTypes = {\n    minZoom: PropTypes.number,\n    queryMode: PropTypes.string,\n    stops: PropTypes.array,\n    refreshStops: PropTypes.func\n  }\n\n  static defaultProps = {\n    minZoom: 15\n  }\n\n  componentDidMount () {\n    // set up pan/zoom listener\n    this.context.map.on('moveend', () => {\n      this._refreshStops()\n    })\n  }\n\n  // TODO: determine why the default MapLayer componentWillUnmount() method throws an error\n  componentWillUnmount () { }\n\n  _refreshStops () {\n    if (this.context.map.getZoom() < this.props.minZoom) {\n      this.forceUpdate()\n      return\n    }\n\n    const bounds = this.context.map.getBounds()\n    if (!bounds.equals(this.lastBounds)) {\n      setTimeout(() => {\n        this.props.refreshStops({\n          minLat: bounds.getSouth(),\n          maxLat: bounds.getNorth(),\n          minLon: bounds.getWest(),\n          maxLon: bounds.getEast()\n        })\n        this.lastBounds = bounds\n      }, 300)\n    }\n  }\n\n  createLeafletElement () {\n  }\n\n  updateLeafletElement () {\n  }\n\n  render () {\n    const { minZoom, setLocation, setViewedStop, setMainPanelContent, stops, languageConfig } = this.props\n    const mobileView = isMobile()\n\n    // Don't render if below zoom threshold or no stops visible\n    if (this.context.map.getZoom() < minZoom || !stops || stops.length === 0) {\n      return <FeatureGroup />\n    }\n\n    // Helper to create StopMarker from stop\n    const createStopMarker = (stop) => <StopMarker\n      key={stop.id}\n      stop={stop}\n      mobileView={mobileView}\n      setLocation={setLocation}\n      setViewedStop={setViewedStop}\n      setMainPanelContent={setMainPanelContent}\n      languageConfig={languageConfig}\n    />\n\n    // Singleton case; return FeatureGroup with single StopMarker\n    if (stops.length === 1) {\n      return <FeatureGroup>{createStopMarker(stops[0])}</FeatureGroup>\n    }\n\n    // Otherwise, return FeatureGroup with mapped array of StopMarkers\n    return <FeatureGroup>{stops.map(stop => createStopMarker(stop))}</FeatureGroup>\n  }\n}\n\nclass StopMarker extends Component {\n  static propTypes = {\n    mobileView: PropTypes.bool,\n    setLocation: PropTypes.func,\n    setViewedStop: PropTypes.func,\n    setMainPanelContent: PropTypes.func,\n    stop: PropTypes.object\n  }\n\n  _onClickView = () => {\n    this.props.setMainPanelContent(null)\n    this.props.setViewedStop({ stopId: this.props.stop.id })\n  }\n\n  render () {\n    const { setLocation, stop, languageConfig } = this.props\n    const { id, name, lat, lon } = stop\n    const idArr = id.split(':')\n    const radius = 20\n    const half = radius / 2\n    const quarter = radius / 4\n    const html = `<div class=\"stop-overlay-icon\" style=\"height: ${half}px; width: ${half}px; margin-left: ${quarter}px; margin-top: ${quarter}px;\" />`\n    const icon = divIcon({\n      html,\n      className: 'stop-overlay-bg',\n      iconSize: radius\n    })\n\n    return (\n      <Marker\n        position={[lat, lon]}\n        icon={icon}\n      >\n        <Popup>\n          <div className='map-overlay-popup'>\n            <div className='popup-title'>{name}</div>\n\n            <div className='popup-row'><b>Agency:</b> {idArr[0]}</div>\n            <div className='popup-row'>\n              <span><b>Stop ID:</b> {idArr[1]}</span>\n              {/* The Stop Viewer button\n                * Note: we use a vanilla Button instead of ViewStopButton because\n                * connected components don't work within react-leaflet Popups)\n                * TODO: Make ViewStopButton work here, perhaps w/ React 16 portals\n                */}\n              <Button\n                className='view-stop-button'\n                bsSize='xsmall'\n                onClick={this._onClickView}\n              >{languageConfig.stopViewer || 'Stop Viewer'}</Button>\n            </div>\n\n            {/* The \"Set as [from/to]\" ButtonGroup */}\n            <div className='popup-row'>\n              <SetFromToButtons\n                map={this.context.map}\n                location={{ lat, lon, name }}\n                setLocation={setLocation}\n              />\n            </div>\n          </div>\n        </Popup>\n      </Marker>\n    )\n  }\n}\n\n// connect to the redux store\n\nconst mapStateToProps = (state, ownProps) => {\n  return {\n    stops: state.otp.overlay.transit.stops,\n    queryMode: state.otp.currentQuery.mode,\n    languageConfig: state.otp.config.language\n  }\n}\n\nconst mapDispatchToProps = {\n  refreshStops: findStopsWithinBBox,\n  clearStops,\n  setLocation,\n  setViewedStop,\n  setMainPanelContent\n}\n\nexport default connect(mapStateToProps, mapDispatchToProps)(StopsOverlay)\n"]}